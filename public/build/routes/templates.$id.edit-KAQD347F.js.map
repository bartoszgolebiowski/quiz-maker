{
  "version": 3,
  "sources": ["../../../app/routes/templates.$id.edit.tsx"],
  "sourcesContent": ["// REMIX HMR BEGIN\nif (!window.$RefreshReg$ || !window.$RefreshSig$ || !window.$RefreshRuntime$) {\n  console.warn('remix:hmr: React Fast Refresh only works when the Remix compiler is running in development mode.');\n} else {\n  var prevRefreshReg = window.$RefreshReg$;\n  var prevRefreshSig = window.$RefreshSig$;\n  window.$RefreshReg$ = (type, id) => {\n    window.$RefreshRuntime$.register(type, \"\\\"app\\\\\\\\routes\\\\\\\\templates.$id.edit.tsx\\\"\" + id);\n  }\n  window.$RefreshSig$ = window.$RefreshRuntime$.createSignatureFunctionForTransform;\n}\nvar _s = $RefreshSig$();\nimport * as __hmr__ from \"remix:hmr\";\nif (import.meta) {\n  import.meta.hot = __hmr__.createHotContext(\n  //@ts-expect-error\n  \"app\\\\routes\\\\templates.$id.edit.tsx\");\n  import.meta.hot.lastModified = \"1714932957561.3008\";\n}\n// REMIX HMR END\n\nimport { json, redirect } from \"@remix-run/node\";\nimport { useFetcher, useLoaderData } from \"@remix-run/react\";\nimport { z } from \"zod\";\nimport { zfd } from \"zod-form-data\";\nimport { error400, error401, error404, error500, formatErrors } from \"~/utils/errors\";\nimport GenericCardServerrErrors from \"~/templates/GenericCardServerrErrors\";\nimport EditTemplate from \"~/templates/EditTemplate\";\nimport { quizContentSchema, templateEditDetailsSchema } from \"~/templates/validation\";\nimport { authAction, loginRequiredLoader } from \"~/auth.server\";\nimport { GetObjectCommand, PutObjectCommand, S3Client } from \"@aws-sdk/client-s3\";\nimport { env } from \"~/env\";\nimport { DynamoDBClient, PutItemCommand } from \"@aws-sdk/client-dynamodb\";\nconst pathParamsSchema = z.object({\n  id: z.coerce.string()\n});\nexport const loader = async args => {\n  const user = await loginRequiredLoader(args);\n  const params = pathParamsSchema.safeParse(args.params);\n  if (!params.success) {\n    const formattedErrors = formatErrors(params.error);\n    throw error400(\"Invalid path params\", formattedErrors);\n  }\n  const s3Client = new S3Client({});\n  const command = new GetObjectCommand({\n    Bucket: env.BUCKET_NAME,\n    Key: `${user.username}/templates/${params.data.id}.json`\n  });\n  let template;\n  try {\n    const response = await s3Client.send(command);\n    if (!response.Body) {\n      throw error404(\"Body not found in response\");\n    }\n    const raw = await response.Body.transformToString();\n    template = templateEditDetailsSchema.parse(JSON.parse(raw));\n  } catch (error) {\n    console.error(error);\n    throw error500(\"Failed to load template\");\n  }\n  if (!template) {\n    throw error404(\"Template not found\");\n  }\n  return json({\n    title: template.title,\n    description: template.description,\n    data: template.data.data\n  });\n};\nexport default function Index() {\n  _s();\n  const data = useLoaderData();\n  const fetcher = useFetcher();\n  const isSubmitting = fetcher.state !== \"idle\";\n  const initial = {\n    title: data.title,\n    description: data.description,\n    data: data.data\n  };\n  const handleSubmit = state => {\n    fetcher.submit({\n      action: \"edit\",\n      data: JSON.stringify(state),\n      title: state.title,\n      description: state.description\n    }, {\n      method: \"POST\"\n    });\n  };\n  return <>\r\n      <EditTemplate initial={initial} isSubmitting={isSubmitting} onSubmit={handleSubmit} />\r\n      {fetcher.data?.type === \"error\" && fetcher.state === \"idle\" ? <GenericCardServerrErrors error={fetcher.data} /> : null}\r\n    </>;\n}\n_s(Index, \"7ZsjsNr2e15PzLVKUx9CA7bMCjw=\", false, function () {\n  return [useLoaderData, useFetcher];\n});\n_c = Index;\nexport const action = async args => {\n  const form = await args.request.formData();\n  switch (form.get(\"action\")) {\n    case \"edit\":\n      return actionEdit(args, form);\n    default:\n      return error400(\"Invalid action\", []);\n  }\n};\nconst editTemplateSchema = zfd.formData({\n  title: zfd.text(z.string().min(1, {\n    message: \"Title is required\"\n  }).max(255, {\n    message: \"Title is too long, max 255 characters\"\n  })),\n  description: zfd.text(z.string().min(1, {\n    message: \"Description is required\"\n  }).max(255, {\n    message: \"Description is too long, max 255 characters\"\n  })).optional().default(\"\"),\n  data: zfd.json(quizContentSchema)\n});\nconst actionEdit = async (args, form) => {\n  return authAction(args, async user => {\n    if (!user.username) {\n      return error401();\n    }\n    const input = editTemplateSchema.safeParse(form);\n    if (!input.success) {\n      const formattedErrors = formatErrors(input.error);\n      return error400(\"Invalid form input\", formattedErrors);\n    }\n    const s3Client = new S3Client({});\n    const dynamodbClient = new DynamoDBClient({});\n    const fileName = `${input.data.title}`;\n    const command = new PutObjectCommand({\n      Bucket: env.BUCKET_NAME,\n      Key: `${user.username}/templates/${fileName}.json`,\n      Body: JSON.stringify({\n        title: input.data.title,\n        description: input.data.description,\n        data: input.data.data\n      })\n    });\n    try {\n      const s3Resposne = await s3Client.send(command);\n      const versionId = s3Resposne.VersionId;\n      if (!versionId) {\n        throw new Error(\"S3 Versioning not enabled\");\n      }\n      const putItemCommand = new PutItemCommand({\n        TableName: env.TABLE_NAME,\n        Item: {\n          userId: {\n            S: user.username\n          },\n          id: {\n            S: fileName\n          },\n          title: {\n            S: input.data.title\n          },\n          version: {\n            S: versionId\n          },\n          description: {\n            S: input.data.description\n          }\n        }\n      });\n      await dynamodbClient.send(putItemCommand);\n      return redirect(`/templates/${fileName}/details`);\n    } catch (error) {\n      console.error(error);\n      return error500(\"Something went wrong\");\n    }\n  });\n};\nvar _c;\n$RefreshReg$(_c, \"Index\");\n\nwindow.$RefreshReg$ = prevRefreshReg;\nwindow.$RefreshSig$ = prevRefreshSig;"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqBA,kBAA+B;AAQ/B,kBAAgD;AA4DvC;AAxFT,IAAI,CAAC,OAAO,gBAAgB,CAAC,OAAO,gBAAgB,CAAC,OAAO,kBAAkB;AAC5E,UAAQ,KAAK,kGAAkG;AACjH,OAAO;AACD,mBAAiB,OAAO;AACxB,mBAAiB,OAAO;AAC5B,SAAO,eAAe,CAAC,MAAM,OAAO;AAClC,WAAO,iBAAiB,SAAS,MAAM,8CAAgD,EAAE;AAAA,EAC3F;AACA,SAAO,eAAe,OAAO,iBAAiB;AAChD;AANM;AACA;AAMN,IAAI,KAAK,aAAa;AAEtB,IAAI,aAAa;AACf,cAAY,MAAc;AAAA;AAAA,IAE1B;AAAA,EAAqC;AACrC,cAAY,IAAI,eAAe;AACjC;AAeA,IAAM,mBAAmB,EAAE,OAAO;AAAA,EAChC,IAAI,EAAE,OAAO,OAAO;AACtB,CAAC;AAkCc,SAAR,QAAyB;AAC9B,KAAG;AACH,QAAM,OAAO,cAAc;AAC3B,QAAM,UAAU,WAAW;AAC3B,QAAM,eAAe,QAAQ,UAAU;AACvC,QAAM,UAAU;AAAA,IACd,OAAO,KAAK;AAAA,IACZ,aAAa,KAAK;AAAA,IAClB,MAAM,KAAK;AAAA,EACb;AACA,QAAM,eAAe,WAAS;AAC5B,YAAQ,OAAO;AAAA,MACb,QAAQ;AAAA,MACR,MAAM,KAAK,UAAU,KAAK;AAAA,MAC1B,OAAO,MAAM;AAAA,MACb,aAAa,MAAM;AAAA,IACrB,GAAG;AAAA,MACD,QAAQ;AAAA,IACV,CAAC;AAAA,EACH;AACA,SAAO,sFACH;AAAA,uDAAC,wBAAa,SAAkB,cAA4B,UAAU,gBAAtE;AAAA;AAAA;AAAA;AAAA,WAAoF;AAAA,IACnF,QAAQ,MAAM,SAAS,WAAW,QAAQ,UAAU,SAAS,mDAAC,oCAAyB,OAAO,QAAQ,QAAzC;AAAA;AAAA;AAAA;AAAA,WAA+C,IAAK;AAAA,OAF/G;AAAA;AAAA;AAAA;AAAA,SAGL;AACJ;AACA,GAAG,OAAO,gCAAgC,OAAO,WAAY;AAC3D,SAAO,CAAC,eAAe,UAAU;AACnC,CAAC;AACD,KAAK;AAUL,IAAM,qBAAqB,gBAAI,SAAS;AAAA,EACtC,OAAO,gBAAI,KAAK,EAAE,OAAO,EAAE,IAAI,GAAG;AAAA,IAChC,SAAS;AAAA,EACX,CAAC,EAAE,IAAI,KAAK;AAAA,IACV,SAAS;AAAA,EACX,CAAC,CAAC;AAAA,EACF,aAAa,gBAAI,KAAK,EAAE,OAAO,EAAE,IAAI,GAAG;AAAA,IACtC,SAAS;AAAA,EACX,CAAC,EAAE,IAAI,KAAK;AAAA,IACV,SAAS;AAAA,EACX,CAAC,CAAC,EAAE,SAAS,EAAE,QAAQ,EAAE;AAAA,EACzB,MAAM,gBAAI,KAAK,iBAAiB;AAClC,CAAC;AAyDD,IAAI;AACJ,aAAa,IAAI,OAAO;AAExB,OAAO,eAAe;AACtB,OAAO,eAAe;",
  "names": []
}
